# ZeroMaps RPC 统一管理面板 Caddy配置
# 使用 ZeroSSL（避免 Let's Encrypt 速率限制）

{
    email vistone868@gmail.com
    acme_ca https://acme.zerossl.com/v2/DV90
}

{DOMAIN} {
    # GitHub Webhook 端点（用于自动更新）
    handle /webhook {
        reverse_proxy 127.0.0.1:9530
    }
    
    # WebSocket 代理（/ws 路径）
    @websocket {
        path /ws
    }
    handle @websocket {
        reverse_proxy 127.0.0.1:9528
    }
    
    # API反向代理（解决混合内容问题）
    handle /api/* {
        # 添加CORS头（允许跨域访问）
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, OPTIONS, POST"
        header Access-Control-Allow-Headers "Content-Type"
        
        # 处理OPTIONS预检请求
        @options {
            method OPTIONS
        }
        respond @options 200
        
        # 反向代理到监控服务
        reverse_proxy 127.0.0.1:9528
    }
    
    # 静态管理面板
    root * /opt/zeromaps-rpc/public
    
    # 禁用 HTML 文件缓存（确保总是获取最新版本）
    @html {
        path *.html /
    }
    header @html {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }
    
    file_server
    
    # Caddy自动HTTPS（自动获取Let's Encrypt证书）
    # 无需手动配置证书路径
    
    # 日志配置（只记录错误，不记录成功的访问日志）
    log {
        output file /var/log/caddy/zeromaps-rpc.log {
            roll_size 10MB
            roll_keep 5
            roll_keep_for 7d
        }
        level ERROR  # 只记录错误，不记录成功的请求
    }
}

