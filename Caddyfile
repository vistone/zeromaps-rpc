# ZeroMaps RPC 统一管理面板 Caddy配置
# 使用 ZeroSSL（避免 Let's Encrypt 速率限制）

{
    email vistone868@gmail.com
    acme_ca https://acme.zerossl.com/v2/DV90
}

{DOMAIN} {
    # GitHub Webhook 端点（用于自动更新）
    handle /webhook {
        reverse_proxy 127.0.0.1:9530
    }
    
    # WebSocket 代理（/ws 路径）
    @websocket {
        path /ws
    }
    handle @websocket {
        reverse_proxy 127.0.0.1:9528
    }
    
    # API反向代理（解决混合内容问题）
    handle /api/* {
        # 添加CORS头（允许跨域访问）
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, OPTIONS, POST"
        header Access-Control-Allow-Headers "Content-Type"
        
        # 处理OPTIONS预检请求
        @options {
            method OPTIONS
        }
        respond @options 200
        
        # 反向代理到监控服务
        reverse_proxy 127.0.0.1:9528
    }
    
    # 静态管理面板
    root * /opt/zeromaps-rpc/public
    file_server
    
    # Caddy自动HTTPS（自动获取Let's Encrypt证书）
    # 无需手动配置证书路径
    
    # 日志
    log {
        output file /var/log/caddy/zeromaps-rpc.log
    }
}

